# wan-monitor-openwrt

> Автоматический мониторинг WAN интерфейса для OpenWrt с перезагрузкой при потере интернета

## 📋 Описание

Скрипт для OpenWrt, который автоматически проверяет доступность интернета на WAN интерфейсе и перезагружает его при обнаружении проблем с подключением. Идеально подходит для нестабильных интернет-соединений, когда требуется автоматическое восстановление связи.

### ✨ Основные возможности

- 🔍 **Автоматическое определение WAN интерфейса** — не требует ручной настройки
- 🌐 **Проверка доступности через два DNS сервера** (Google и Cloudflare)
- 🔄 **Автоматическая перезагрузка интерфейса** при потере интернета
- 📊 **Подробное логирование** всех действий с временными метками
- ⏰ **Поддержка автоматического запуска** по расписанию через cron
- 🎯 **Умная логика перезапуска** — выжидает 30 секунд для установки соединения

## 🚀 Быстрый старт

### Установка

1. **Скопируйте скрипт на роутер:**
```sh
wget -O /root/wan_monitor.sh https://raw.githubusercontent.com/lQwestl/wan-monitor-openwrt/main/wan_monitor.sh
chmod +x /root/wan_monitor.sh
```

Или создайте файл вручную:
```sh
nano /root/wan_monitor.sh
# Вставьте содержимое скрипта
chmod +x /root/wan_monitor.sh
```

2. **Проверьте работу:**
```sh
/root/wan_monitor.sh
```

### Настройка автоматического запуска

**Для проверки каждые 10 минут:**

```sh
# Откройте crontab
crontab -e

# Добавьте строку
*/10 * * * * /root/wan_monitor.sh

# Перезапустите cron
/etc/init.d/cron restart
```

**Другие варианты расписания:**

```sh
# Каждые 5 минут
*/5 * * * * /root/wan_monitor.sh

# Каждые 15 минут
*/15 * * * * /root/wan_monitor.sh

# Каждый час
0 * * * * /root/wan_monitor.sh
```

## 🔧 Настройка

В начале скрипта можно изменить следующие параметры:

```sh
PING_HOST="8.8.8.8"          # Основной хост для проверки (Google DNS)
PING_HOST_2="1.1.1.1"        # Резервный хост (Cloudflare DNS)
PING_COUNT=3                  # Количество пинг-пакетов
PING_TIMEOUT=5                # Таймаут для каждого пинга (секунды)
LOG_FILE="/var/log/wan_monitor.log"  # Путь к файлу логов
```

### Рекомендуемые настройки

**Для стабильных соединений:**
- Интервал проверки: 15 минут
- PING_COUNT: 3
- PING_TIMEOUT: 5

**Для нестабильных соединений:**
- Интервал проверки: 5 минут
- PING_COUNT: 5
- PING_TIMEOUT: 3

## 📊 Работа с логами

### Просмотр логов

```sh
# Показать весь лог
cat /var/log/wan_monitor.log

# Показать последние 50 строк
tail -n 50 /var/log/wan_monitor.log

# Следить за логом в реальном времени
tail -f /var/log/wan_monitor.log

# Найти все перезагрузки интерфейса
grep "Перезагрузка" /var/log/wan_monitor.log
```

### Пример вывода лога

```
[2025-10-02 17:32:41] ════════════════════════════════════════
[2025-10-02 17:32:41] Запуск мониторинга WAN интерфейса
[2025-10-02 17:32:41] ════════════════════════════════════════
[2025-10-02 17:32:41] ✓ Найден WAN интерфейс: wan
[2025-10-02 17:32:41] Логический интерфейс: wan
[2025-10-02 17:32:41] Физическое устройство: eth1
[2025-10-02 17:32:41] Хосты для проверки: 8.8.8.8, 1.1.1.1
[2025-10-02 17:32:41] ────────────────────────────────────────
[2025-10-02 17:32:41] Проверка подключения к интернету...
[2025-10-02 17:32:41] ✓ Интернет доступен (проверка через 8.8.8.8)
[2025-10-02 17:32:41] Мониторинг завершен: все в порядке
[2025-10-02 17:32:41] ════════════════════════════════════════
```

### Очистка логов

```sh
# Очистить лог файл
> /var/log/wan_monitor.log

# Или удалить
rm /var/log/wan_monitor.log
```

## 🔍 Как работает скрипт

1. **Определение WAN интерфейса:**
   - Ищет интерфейсы с именем содержащим "wan"
   - Проверяет активность интерфейса
   - В качестве резерва ищет интерфейс с маршрутом по умолчанию

2. **Проверка доступности:**
   - Пингует основной хост (Google DNS 8.8.8.8)
   - При неудаче пингует резервный хост (Cloudflare DNS 1.1.1.1)
   - Использует физическое устройство для корректной маршрутизации

3. **Восстановление соединения:**
   - Выключает WAN интерфейс
   - Ждет 5 секунд
   - Включает WAN интерфейс
   - Ждет 30 секунд для установки соединения
   - Повторно проверяет доступность

## 💡 Дополнительные примеры использования

### Ручной запуск с выводом в консоль

```sh
/root/wan_monitor.sh
```

### Запуск в фоне

```sh
/root/wan_monitor.sh &
```

### Создание алиаса

```sh
# Добавьте в /etc/profile или ~/.profile
echo "alias wan-check='/root/wan_monitor.sh'" >> /etc/profile

# Теперь можно использовать
wan-check
```

### Проверка статуса WAN интерфейса

```sh
# Посмотреть информацию об интерфейсе
ifstatus wan

# Посмотреть маршруты
ip route show

# Посмотреть статус всех интерфейсов
ubus call network.interface dump
```

## 🛠️ Устранение проблем

### Скрипт не находит WAN интерфейс

Проверьте доступные интерфейсы:
```sh
ubus call network.interface dump | jsonfilter -e '@.interface[@.interface!="loopback"].interface'
```

### Перезагрузка не помогает восстановить интернет

1. Проверьте настройки WAN интерфейса в LuCI
2. Убедитесь, что проблема не на стороне провайдера
3. Попробуйте увеличить время ожидания после перезагрузки (в скрипте измените `sleep 30` на большее значение)

### Лог файл слишком большой

Настройте ротацию логов:
```sh
# Создайте файл /etc/logrotate.d/wan_monitor
cat > /etc/logrotate.d/wan_monitor << 'EOF'
/var/log/wan_monitor.log {
    size 1M
    rotate 3
    compress
    missingok
    notifempty
}
EOF
```

## ⚙️ Требования

- **OpenWrt** 24.10 (проверялось на этой версии)
- **BusyBox** с командами: `ping`, `date`, `ifup`, `ifdown`
- **Пакеты:** `jsonfilter` (обычно установлен по умолчанию)

## 🧪 Тестирование

### Проверка работы скрипта

```sh
# Запустите скрипт и проверьте вывод
/root/wan_monitor.sh

# Проверьте, что лог создан
ls -lh /var/log/wan_monitor.log
```

### Тест при отключенном интернете

```sh
# Отключите WAN интерфейс
ifdown wan

# Запустите скрипт
/root/wan_monitor.sh

# Скрипт должен обнаружить отсутствие интернета и перезагрузить интерфейс
```

## 📚 Дополнительная информация

### Альтернативные хосты для проверки

Вы можете использовать другие надежные DNS серверы:
- `8.8.4.4` (Google DNS альтернативный)
- `9.9.9.9` (Quad9)
- `208.67.222.222` (OpenDNS)
- `1.0.0.1` (Cloudflare альтернативный)
